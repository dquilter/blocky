<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
	<script type="text/javascript" src="phaser.min.js"></script>
	<style type="text/css">
		body {
			margin: 0;
		}
	</style>
</head>

<body>

	<script type="text/javascript">
		var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
			preload: preload,
			create: create,
			update: update
		});

		function preload() {
			game.load.image('ground', 'platform.png');
			game.load.image('star', 'star.png');
		}

		function create() {

			//  We're going to be using physics, so enable the Arcade Physics system
			game.physics.startSystem(Phaser.Physics.ARCADE);

			//  The platforms group contains the ground and the platforms we can jump on
			platformsGroup = game.add.group();
			//  We will enable physics for any object that is created in this group
			platformsGroup.enableBody = true;

			// Here we create the ground.
			var ground = platformsGroup.create(0, game.world.height - 64, 'ground');
			//  Scale it to fit the width of the game (the original sprite is 400x32 in size)
			ground.scale.setTo(2, 2);
			//  This stops it from falling away when you jump on it
			ground.body.immovable = true;

			//  Create a platform
			var platform = new Platform();
			
			// Create guard
			platformsArray.forEach(function(elem, index, array) {
				var thisGuard = new Guard(elem);
			});

			// The player and its settings
			player = game.add.sprite(32, game.world.height - 150, 'star');
			//  We need to enable physics on the player
			game.physics.arcade.enable(player);
			//  Player physics properties. Give the little guy a slight bounce.
			player.body.bounce.y = 0.2;
			player.body.gravity.y = 450;
			player.body.collideWorldBounds = true;

			cursors = game.input.keyboard.createCursorKeys();
		}

		function update() {

			//  Collide the player and the stars with the platforms
			game.physics.arcade.collide(player, platformsGroup);
			//  Reset the players velocity (movement)
			player.body.velocity.x = 0;

			if (cursors.left.isDown) {
				//  Move to the left
				player.body.velocity.x = -150;

				player.animations.play('left');
			} else if (cursors.right.isDown) {
				//  Move to the right
				player.body.velocity.x = 150;

				player.animations.play('right');
			} else {
				//  Stand still
				player.animations.stop();

				player.frame = 4;
			}

			//  Allow the player to jump if they are touching the ground.
			if (cursors.up.isDown && player.body.touching.down) {
				player.body.velocity.y = -350;
			}

			//  Collide the guard and the stars with the platforms
			guards.forEach(function(elem, index, array) {
				game.physics.arcade.collide(elem.phaserRef, platformsGroup);
				game.physics.arcade.collide(elem.phaserRef, player);
				elem.phaserRef.body.velocity.x = 0;
				elem.patrol();
			});

		}
		
		var guards = [];
		var platformsArray = [];
		
		var Platform = function() {
			this.phaserRef = platformsGroup.create(400, 400, 'ground');
			platformsArray.push(this)
			
			this.phaserRef.body.immovable = true;
			this.platformBounds = [400 + 10, 400 + 400 - 10]
			// [leftPos + 10, leftPos + platformLength - 10]
		}
		
		var Guard = function(platform) {
			// Set up phaser object and refs
			this.phaserRef = game.add.sprite(450, game.world.height - 450, 'star');
			guards.push(this)
			
			// Phaser settings
			game.physics.arcade.enable(this.phaserRef);
			this.phaserRef.body.gravity.y = 450;
			this.phaserRef.body.collideWorldBounds = true;
			
			// Custom props
			this.territory = platform;
			this.patrolDir = -1; // -1 for left, 1 for right
			this.patrolling = false;
			
			// Custom methods
			this.patrol = function() {
				// Start patrolling after drop
				if (this.patrolling === false && this.phaserRef.body.touching.down) {
					this.patrolling = true;
				}
				
				// Out of bounds left
				if (this.patrolDir === -1 && this.phaserRef.position.x < this.territory.platformBounds[0]) {
					this.reverseDir();
				}
				// Out of bounds right
				if (this.patrolDir === 1 && this.phaserRef.position.x > this.territory.platformBounds[1]) {
					this.reverseDir();
				}
				// Screen edge
				if (this.phaserRef.body.blocked.left || this.phaserRef.body.blocked.right) {
					this.reverseDir();
				}
				
				if (this.patrolling === true) {
					this.phaserRef.body.velocity.x = 100 * this.patrolDir;
				}
				
			},
			this.reverseDir = function() {
				console.log('reverse');
				console.log(this.patrolDir)
				this.patrolDir = this.patrolDir * -1;
			}
		}
	</script>

</body>

</html>